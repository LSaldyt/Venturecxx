Overview
========

If you disagree with a suggestion you see here, please bring it up
rather than silently not following it.

- We use [Github Issues](http://github.com/mit-probabilistic-computing-project/Venturecxx/Issues/) to track issues.

- We use [Flowdock](https://www.flowdock.com/app/mit-probcomp/main) for persistent group chat.

- We use [nosetests](https://nose.readthedocs.org/en/latest/) for running the test suite.

- We have a compute cluster at `probcomp-{1,2,3,4}.csail.mit.edu`, and we have EC2 as a fallback.

- We use [Jenkins](http://jenkins-ci.org/) for the continuous build.  As of this writing, the
  server listens to https://probcomp-3.csail.mit.edu/

- We use [pylint](http://www.pylint.org/) to maintain our Python code style.  The normative
  pylint configuration file is in `tool/pylintrc`.  See also [pylint](#pylint).

- We have a [Testing Policy](#testing-policy).

- We have a [Dependencies Policy](#dependencies-policy) for Python dependencies.

Particulars
===========

Testing Policy
--------------

- `nosetests -c crashes.cfg` runs the suite to quickly check for
  crashes without measuring inference quality.  Please keep this test
  suite passing on the master branch; raise `nose.SkipTest` if
  necessary.

    - `nosetests -c lite-crashes.cfg` runs only the tests that test
      the Lite backend

    - `nosetests -c puma-crashes.cfg` runs only the tests that test
      the Puma backend

    - `nosetests -c crashes.cfg --tc=get_ripl:lite` runs all the
      tests, using the Lite backend where not specified in the test.
      `puma` likewise.

- We treat a skipped test as an issue.  To wit, resolution is required
  but need not be immediate.  The actual skipped test should ideally
  be linked to an issue in the issue tracker. [*] When that issue is
  closed, the test should be re-enabled.  Issues that have skipped
  tests associated with them should ideally be marked as such, so the
  tests can be found (by grep) and turned back on.

  [*] Typically by copying the issue's URL into the message given to
  the SkipTest exception.

- See [test/README.md](https://github.com/mit-probabilistic-computing-project/Venturecxx/tree/master/test)
  for the organization of the test suite.

Test Suite Configuration
------------------------

- `all-crashes` checks for crashes in several generic inference programs.

- `nosetests -c inference-quality.cfg` checks for inference quality
  problems.

- You can select the default inference program (used when the
  particular test doesn't specify) like this:
  `nosetests -c inference-quality.cfg --tc=infer:"(func_pgibbs default ordered 10 3)"`
  The default is `(mh default one 100)`.

- `all-inference-quality` checks inference quality in several generic
  inference programs.  This takes a while.

- `nosetests -c performance.cfg` checks for performance issues.
  Currently there are only a handful of performance tests, all of
  which are asymptotic checks rather than benchmarks.

- The test suite can be sliced by test/group in the usual way.

- See `test/lite-config.py` and `test/config.py` for other configuration
  options.

- Python-side code coverage can be obtained via coverage.py and the
  nose-cov plugin.  A coverage report is generated by default when doing
  crash testing.  Read `crashes.cfg` to see how it's done.

- Ideally, we would define additional task-oriented test launch patterns:
  - Benchmark an inference program in a backend
    - speed per transition
    - convergence per transition
    - convergence per computron
  - Profile the computations triggered by the tests (statistically or by instrumentation)
  - Issue: https://app.asana.com/0/9277419963067/10442847514621

Dependencies Policy
-------------------

The definitive list of Venture's Python dependencies is in
`requirements.txt`.  The honor of the project is tarnished if an
installation exists that satisfies the requirements listed there but
Venture does not run on it because of a Python library version
problem.

Pylint
------

We use pylint to maintain a Python code style.  The normative style
file is in `tool/pylintrc`.  A number of existing style violations are
grandfathered, but we try not to introduce new ones.

- You can run pylint in batch mode using the Venture style with, e.g.,
  `pylint --rcfile=tool/pylintrc backend/lite/wttree.py`

- Pylint is more useful if the feedback is instantaneous.  If you edit
    in Emacs, this can be achieved using Flymake Mode:

    1. Either add the `tool/` directory to your PATH, or put a symlink
       on your path named `venture-epylint.py` and pointing to
       `tool/venture-epylint.py`

    2. Make sure your Emacs loads `tool/python-flymake.el` on startup,
       for example by adding `(load-file "/path/to/venture/tool/python-flymake.el")`
       to your `.emacs` file.

- Our attitude towards style violations is:

  - Code you recently understood (i.e., wrote, or heavily modified)
    should conform to the project style.
  - If there is a good reason to deviate from style, add a comment
    with `pylint: disable=<violation-type>` and a comment explaining
    why.
  - If you feel that a particular style constraint is too strict or
    inappropriate in general, let's discuss it.

Debugging C++ in GDB
--------------------

One way to run the Puma backend through Python under GDB is to create
a file named `Venturecxx/.gdbinit` with content like

```
target exec python
run /usr/bin/nosetests [params]
```

In order for this to work, it may be necessary to add a line like

```
add-auto-load-safe-path /home/axch/work/pcp/Venturecxx/.gdbinit
```

to one's `~/.gdbinit`.  With that ready, just run `gdb`.

Checking C++ with Valgrind
--------------------------

We have a Valgrind suppressions file for problems that are (apprently)
caused by Python rather than our code: `backend/new_cxx/valgrind-python.supp`.

Check out the `tool/grind` script for an example of how to use it.
