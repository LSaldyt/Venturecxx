Overview
========

If you disagree with a suggestion you see here, please bring it up
rather than silently not following it.

- We use [Asana](http://asana.com) to coordinate tasks.

- We use [Flowdock](https://www.flowdock.com/app/mit-probcomp/main) for persistent group chat.

- We use [nosetests](https://nose.readthedocs.org/en/latest/) for running the test suite.

- We use [Starcluster](http://star.mit.edu/cluster/) (which is backed by EC2) for cloud compute.

- We use [Jenkins](http://jenkins-ci.org/) for the continuous build.  As of this writing, the
  server listens to http://ec2-54-84-30-252.compute-1.amazonaws.com:8080/

- We use [pylint](http://www.pylint.org/) to maintain our Python code style.  The normative
  pylint configuration file is in `tool/pylintrc`.

- We have a [Testing Policy](#testing-policy).

- We have a [Dependencies Policy](#dependencies-policy) for Python dependencies.

Particulars
===========

Testing Policy
--------------

- `nosetests -c crashes.cfg` runs the suite to quickly check for
  crashes without measuring inference quality.  Please keep this test
  suite passing on the master branch; raise `nose.SkipTest` if
  necessary.

    - `nosetests -c lite-crashes.cfg` runs only the tests that test
      the Lite backend

    - `nosetests -c puma-crashes.cfg` runs only the tests that test
      the Puma backend

- We treat a skipped test as an issue.  To wit, resolution is required
  but need not be immediate.  The actual skipped test should be linked
  to an issue in the issue tracker. [*] When that issue is closed, the
  test should be re-enabled.  Issues that have skipped tests
  associated with them should be marked as such, so the tests can be
  found (by grep) and turned back on.

  [*] While we're using Asana as the main issue tracker, this means
  copy the Asana URL of the task into the message given to the
  SkipTest exception.

Test Suite Configuration
------------------------

- `all-crashes` checks for crashes in several generic inference programs.

- `nosetests -c inference-quality.cfg` checks for inference quality
  problems.

- You can select the default inference program (used when the
  particular test doesn't specify) like this:
  `nosetests -c inference-quality.cfg --tc=infer:"(func_pgibbs default ordered 10 3)"`
  The default is `(mh default one 50)`.

- `all-inference-quality` checks inference quality in several generic
  inference programs.  This takes a while.

- You can select the backend against which to run the suite like this:
  `nosetests -c inference-quality.cfg --tc=get_ripl:puma`
  (the default is `lite`).

- `nosetests -c performance.cfg` checks for performance issues.
  Currently there are only three performance tests, all of which are
  asymptotic checks rather than benchmarks.

- See [test/README.md](https://github.com/mit-probabilistic-computing-project/Venturecxx/tree/master/test)
  for the organization of the test suite.

- The test suite can be run in parallel via the nose multiprocessing
  plugin:
  `--processes=[NUM] --process-timeout=[SECONDS]`
  Note that the timeout is essentially for the whole suite rather than
  per test.  This facility has caused no end of problems, so the
  continuous build now parallelizes across builds rather than within
  them.

- The test suite can be sliced by test/group in the usual way.

- See `test/lite-config.py` and `test/config.py` for other configuration
  options.

- Python-side code coverage can be obtained via coverage.py and the
  nose-cov plugin.  A coverage report is generated by default when doing
  crash testing.  Read `crashes.cfg` to see how it's done.

- Ideally, we would define additional task-oriented test launch patterns:
  - Benchmark an inference program in a backend
    - speed per transition
    - convergence per transition
    - convergence per computron
  - Profile the computations triggered by the tests (statistically or by instrumentation)
  - Issue: https://app.asana.com/0/9277419963067/10442847514621

Dependencies Policy
-------------------

The definitive list of Venture's Python dependencies is in
`requirements.txt`.  The honor of the project is tarnished if an
installation exists that satisfies the requirements listed there but
Venture does not run on it because of a Python library version
problem.

Starcluster
-----------

- We have a Starcluster Venture plugin in that lets you painlessly get
  a cluster with Venture installed on every node.  See instructions in
  `tool/scventure.py` for how to use it (assuming you already know how
  to use Starcluster).  For development, we suggest you configure the
  plugin to build Venture either from a Github branch or from your
  local clone.

Pylint
------

- Our pylint config doesn't work with the version packaged for Ubuntu,
  so install pylint from pip:
  `sudo pip install pylint`

- You can run pylint in batch mode using the Venture style with, e.g.,
  `pylint --rcfile=tool/pylintrc backend/lite/wttree.py`

- Pylint is more useful if the feedback is instantaneous.  If you edit
    in Emacs, this can be achieved using Flymake Mode:

    1. Either add the `tool/` directory to your PATH, or put a symlink
       on your path named `venture-epylint.py` and pointing to
       `tool/venture-epylint.py`

    2. Make sure your Emacs loads `tool/python-flymake.el` on startup,
       for example by adding `(load-file "/path/to/venture/tool/python-flymake.el")`
       to your `.emacs` file.

- Our attitude towards style violations is:

  - Code you recently understood (i.e., wrote, or heavily modified)
    should conform to the project style.
  - If there is a good reason to deviate from style, add a comment
    with `pylint: disable=<violation-type>` and a comment explaining
    why.
  - If you feel that a particular style constraint is too strict or
    inappropriate in general, let's discuss it.

Debugging C++ in GDB
--------------------

One way to run the Puma backend through Python under GDB is to create
a file named `Venturecxx/.gdbinit` with content like

```
target exec python
run /usr/bin/nosetests [params]
```

In order for this to work, it may be necessary to add a line like

```
add-auto-load-safe-path /home/axch/work/pcp/Venturecxx/.gdbinit
```

to one's `~/.gdbinit`.  With that ready, just run `gdb`.

Checking C++ with Valgrind
--------------------------

We have a Valgrind suppressions file for problems that are (apprently)
caused by Python rather than our code: `backend/new_cxx/valgrind-python.supp`.

Check out the `tool/grind` script for an example of how to use it.
